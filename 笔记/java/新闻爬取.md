# dwnews.com新闻爬取(尝试)
### 设想
使用Centos自带的定时程序,用java获取并处理网页,将数据用mailx(见/笔记/其他/搬瓦工VPS部分)发送到我的QQ邮箱.

### 思路
##### Java部分
1.java读取首页

2.获取首页的所有超链接(<a>标签)

3.链接存入数据库,添加'sent=true/false'标记,sent默认为false

4.java连接数据库,查询'sent=false'的行

5.读取网页,格式处理,输出内容到'A.txt'

6.将sent字段改为'true'

##### shell部分
1.定时任务

crontab -e
```
0 * * * * /root/DwNews/auto.sh
```
(每个整点自动运行auto.sh)

2.新建/root/DwNews/auto.sh
``` bash
cd /root/DwNews/
# 更新首页数据
java -jar dwnews.jar update
for((i=1;i<=10;i++)); do
java -jar dwnews.jar sendmail
sleep 2
mutt -s "News"  876221344@qq.com  < A.txt
sleep 1
rm -rf A.txt
done
```




### java 代码
xyz.cym2018.Main.java
``` java
package xyz.cym2018;
public class Main {
    public static void main(String[] args) {
        // 更新首页数据
        if (args[0].contains("update")) {
            ReadHomePage.main(null);
        }
        // 读取下一个未读的链接
        if (args[0].contains("sendmail")) {
            ReadArticle.main(null);
        }
    }
}
```
xyz.cym2018.ReadHomePage.java
```java
package xyz.cym2018;
public class ReadHomePage {
    public static void main(String[] args) {
        // 读取页面
        String HTML = HttpRequest.GetHTML("http://www.dwnews.com");
        // 获取链接列表
        LinkList(HTML);
    }

    // 获取超链接列表
    private static void LinkList(String input) {
        int iStart, iEnd;
        // 检测第一个超链接
        iStart = input.indexOf("<a");
        iEnd = input.indexOf("</a", iStart) + 4;
        while (iStart != -1) {
            String temp = input.substring(iStart, iEnd);
            // 存在超链接嵌套,
            if (temp.indexOf("<a", 5) > -1) {
                iStart = temp.indexOf("<img");
                temp = temp.substring(iStart);
            }
            // 清除多余的链接
            if (temp.contains("html") && !temp.contains("广告") && !temp.contains("tag") && !temp.contains("ico") && !temp.contains("tag")) {
                temp = RemoveAllTag(temp);
                JudgeType(temp);
            }
            // 切割文本,检测下一个超链接
            input = input.substring(iEnd);
            iStart = input.indexOf("<a");
            iEnd = input.indexOf("</a", iStart) + 4;
        }
    }
    // 判断文本包含的数据内容,分情况保存
    private static void JudgeType(String input) {
        DBHelper dbHelper = new DBHelper();
        int temp1, temp2;
        if (!input.contains("img")) {
            // 文字+链接
            String title, url;
            temp1 = input.indexOf("http");
            temp2 = input.indexOf("html", temp1) + 4;
            url = input.substring(temp1, temp2);
            temp1 = input.indexOf(">") + 1;
            temp2 = input.indexOf("</a", temp1);
            title = input.substring(temp1, temp2);
            dbHelper.UrlTitle(url, title);
        } else if (input.contains("data-title")) {
            // 文字+链接+图片
            String img, url, title;
            temp1 = input.indexOf("img src=\"") + 9;
            temp2 = input.indexOf("jpg", temp1) + 3;
            img = input.substring(temp1, temp2);
            temp1 = input.indexOf("href=") + 6;
            temp2 = input.indexOf("\"", temp1);
            url = input.substring(temp1, temp2);
            temp1 = input.indexOf(" >") + 2;
            temp2 = input.indexOf("</a", temp1);
            title = input.substring(temp1, temp2);
            dbHelper.UrlTitleImg(url, title, img);
        } else {
            // 链接+图片
            String img, url;
            temp1 = input.indexOf("http");
            temp2 = input.indexOf("html", temp1) + 4;
            url = input.substring(temp1, temp2);
            temp1 = input.indexOf("img src=\"") + 9;
            temp2 = input.indexOf("\"", temp1 + 1);
            img = input.substring(temp1, temp2);
            dbHelper.UrlImg(url, img);
        }
    }
    // 标记标签内需要删除的属性
    private static String RemoveAllTag(String input) {
        String[] tags = {"DWBLOCK", "mixpanel.track", "target", "class", "width", "ikey"};
        for (String s : tags) {
            input = RemoveTag(input, s);
        }
        return input;
    }
    // 删除标签内多余的属性(Tag为翻译错误)
    private static String RemoveTag(String input, String tag) {
        int temp1, temp2;
        temp1 = input.indexOf(tag + "=");
        temp2 = input.indexOf("\"", temp1 + tag.length() + 2) + 1;
        return temp1 == -1 ? input : input.substring(0, temp1) + input.substring(temp2);
    }
}
```
xyz.cym2018.ReadArticle.java
```java
package xyz.cym2018;
public class ReadArticle {
    public static void main(String[] args) {
        String url, HTML;
        DBHelper dbHelper = new DBHelper();
        // 读取下一个未读的链接
        url = dbHelper.GetInfo();
        // 读取网页
        HTML = HttpRequest.GetHTML(url);
        // 组合文章
        HTML = MakeArticle(HTML);
        // 保存
        FileHelper.FileA(HTML);
    }
    // 组合每个<p>标签内的内容
    private static String MakeArticle(String input) {
        StringBuilder Article = new StringBuilder();
        int temp1, temp2, temp3;
        temp1 = input.indexOf("<p");
        temp2 = input.indexOf(">", temp1 + 2) + 1;
        temp3 = input.indexOf("</p", temp1);
        while (temp3 != -1) {
            Article.append(input, temp2, temp3);
            input = input.substring(temp3 + 3);
            temp1 = input.indexOf("<p");
            temp2 = input.indexOf(">", temp1 + 2) + 1;
            temp3 = input.indexOf("</p", temp1);
        }
        // 删除残余标签
        temp1 = Article.indexOf("<");
        temp2 = Article.indexOf(">", temp1);
        while (temp1 != -1 && temp2 != -1) {
            Article = Article.replace(temp1, temp2 + 1, "");
            temp1 = Article.indexOf("<");
            temp2 = Article.indexOf(">", temp1);
        }
        return Article.toString();
    }
}
```
xyz.cym2018.HttpRequest.java
```java
package xyz.cym2018;
import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import java.io.IOException;
class HttpRequest {
    static String GetHTML(String url) {
        String ret = "";
        CloseableHttpClient httpClient;
        CloseableHttpResponse response;
        httpClient = HttpClients.createDefault();
        HttpGet httpget = new HttpGet(url);
        try {
            response = httpClient.execute(httpget);
            HttpEntity entity = response.getEntity();
            ret = "" + EntityUtils.toString(entity, "UTF-8");
            httpClient.close();
            response.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return ret;
    }
}
```
xyz.cym2018.FileHelper.java
```java
package xyz.cym2018;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
class FileHelper {
    static void FileA(String input) {
        FileWriter fileWriter;
        BufferedWriter bufferWriter;
        File file = new File("A.txt");
        if (!file.exists()) {
            try {
                if (!file.createNewFile()) {
                    System.out.println("权限不足,无法创建A.txt");
                    System.exit(0);
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        try {
            fileWriter = new FileWriter(file.getName(), true);
            bufferWriter = new BufferedWriter(fileWriter);
            bufferWriter.write(input);
            bufferWriter.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```
xyz.cym2018.DBHelper.java
```java
package xyz.cym2018;
import java.sql.*;
class DBHelper {
    private static final ThreadLocal<Connection> connection = new ThreadLocal<>();
    private Connection conn;
    private PreparedStatement preparedStatement;
    DBHelper() {
        conn = connection.get();
        if (conn == null) {
            try {
                Class.forName("com.mysql.cj.jdbc.Driver");
                conn = DriverManager.getConnection("jdbc:mysql://localhost/News?user=root&password=ab370126&serverTimezone=UTC&characterEncoding=utf8");
                connection.set(conn);
            } catch (ClassNotFoundException | SQLException e) {
                e.printStackTrace();
            }
        }
    }
    void UrlTitle(String url, String title) {
        try {
            PreparedStatement preparedStatement = conn.prepareStatement("insert into news(url,title) values (?,?);");
            preparedStatement.setString(1, url);
            preparedStatement.setString(2, title);
            preparedStatement.execute();
        } catch (SQLException e) {
            try {
                PreparedStatement preparedStatement = conn.prepareStatement("update news set title=? where url=?");
                preparedStatement.setString(1, title);
                preparedStatement.setString(2, url);
                preparedStatement.execute();
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
        }
    }
    void UrlTitleImg(String url, String title, String img) {
        try {
            preparedStatement = conn.prepareStatement("insert into news(url,title,img) values (?,?,?);");
            preparedStatement.setString(1, url);
            preparedStatement.setString(2, title);
            preparedStatement.setString(2, img);
            preparedStatement.execute();
        } catch (SQLException e) {
            try {
                PreparedStatement preparedStatement = conn.prepareStatement("update news set title=? ,img=? where url=?");
                preparedStatement.setString(1, title);
                preparedStatement.setString(2, img);
                preparedStatement.setString(3, url);
                preparedStatement.execute();
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
        }
    }
    void UrlImg(String url, String img) {
        try {
            PreparedStatement preparedStatement = conn.prepareStatement("insert into news(url,img) values (?,?);");
            preparedStatement.setString(1, url);
            preparedStatement.setString(2, img);
            preparedStatement.execute();
        } catch (SQLException e) {
            try {
                PreparedStatement preparedStatement = conn.prepareStatement("update news set img=?  where url=?");
                preparedStatement.setString(1, img);
                preparedStatement.setString(2, url);
                preparedStatement.execute();
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
        }
    }
    String GetInfo() {
        try {
            PreparedStatement preparedStatement = conn.prepareStatement("select * from news where sent=0");
            ResultSet rs = preparedStatement.executeQuery();
            rs.next();
            FileHelper.FileA(rs.getString(2));
            FileHelper.FileA("\n<img src=\"" + rs.getString(3) + "\">\n");
            SetSent(rs.getString(1));
            return rs.getString(1);
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
    private void SetSent(String url) {
        try {
            preparedStatement = conn.prepareStatement("update news set sent=1 where url=?");
            preparedStatement.setString(1, url);
            preparedStatement.execute();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```
数据库
```sql
set character_set_client='utf8';
set character_set_connection='utf8';
set character_set_database='utf8';
set character_set_results='utf8';
set character_set_server='utf8';
Drop database News;
create database News;
use News;
create table news(url varchar(254) primary key not null,title varchar(254),img varchar(254),sent bool default false);
show variables like  'character%';
```
maven配置
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>JavaTools</groupId>
    <artifactId>DWNews2Mail</artifactId>
    <version>1.0-SNAPSHOT</version>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>8</source>
                    <target>8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
    <dependencies>
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5.10</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.18</version>
        </dependency>
    </dependencies>
</project>
```
